name: Build and Deploy to Appetize

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Install XcodeGen
        run: |
          # Install specific version compatible with Xcode 15
          brew install xcodegen

      - name: Generate Xcode Project
        run: |
          # Generate with explicit compatibility
          xcodegen generate --spec project.yml

          # Fix the project format if needed
          sed -i '' 's/objectVersion = 77/objectVersion = 56/g' VirtualDeck.xcodeproj/project.pbxproj || true

      - name: List available schemes
        run: xcodebuild -project VirtualDeck.xcodeproj -list

      - name: Build for iOS Simulator (ARM64)
        run: |
          xcodebuild build \
            -project VirtualDeck.xcodeproj \
            -scheme VirtualDeck \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
            -configuration Debug \
            -derivedDataPath ./build \
            -arch arm64 \
            ONLY_ACTIVE_ARCH=NO \
            ARCHS=arm64 \
            CODE_SIGNING_ALLOWED=NO

      - name: Verify and zip the app
        run: |
          APP_PATH=$(find ./build -name "*.app" -type d | head -1)
          echo "Found app at: $APP_PATH"

          # Verify app bundle structure
          echo "### App Bundle Verification ###"
          echo "Bundle contents:"
          ls -la "$APP_PATH/"

          # Check for Info.plist
          if [ -f "$APP_PATH/Info.plist" ]; then
            echo "âœ… Info.plist found"
            echo "Info.plist contents:"
            cat "$APP_PATH/Info.plist"
          else
            echo "âŒ Missing Info.plist!"
            exit 1
          fi

          # Check for executable
          APP_NAME=$(basename "$APP_PATH" .app)
          if [ -f "$APP_PATH/$APP_NAME" ]; then
            echo "âœ… Executable found: $APP_NAME"
            # Check architecture
            file "$APP_PATH/$APP_NAME"
            echo "Architecture info:"
            lipo -info "$APP_PATH/$APP_NAME" || true
          else
            echo "âŒ Missing executable!"
            exit 1
          fi

          # Create the zip
          cd $(dirname "$APP_PATH")
          zip -r VirtualDeck.zip $(basename "$APP_PATH")
          mv VirtualDeck.zip $GITHUB_WORKSPACE/

          # Show final file size
          echo "### Final Bundle Size ###"
          ls -lh $GITHUB_WORKSPACE/VirtualDeck.zip

      - name: Upload to Appetize.io
        id: appetize
        run: |
          echo "Uploading VirtualDeck.zip to Appetize.io..."
          echo "File size: $(ls -lh VirtualDeck.zip | awk '{print $5}')"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.appetize.io/v1/apps" \
            -H "X-API-KEY: ${{ secrets.APPETIZE_API_TOKEN }}" \
            -F "file=@VirtualDeck.zip" \
            -F "platform=ios")

          # Extract HTTP status code (last line) and response body
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status Code: $HTTP_CODE"
          echo "Appetize Response: $BODY"

          # Check for errors
          if [[ "$HTTP_CODE" != "200" ]]; then
            echo "### âŒ Appetize Upload Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**HTTP Status:** $HTTP_CODE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Response:** \`$BODY\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Check if publicKey is present
          PUBLIC_KEY=$(echo "$BODY" | jq -r '.publicKey // empty')
          if [[ -z "$PUBLIC_KEY" ]]; then
            echo "### âŒ Appetize Upload Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Error:** No publicKey in response" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Response:** \`$BODY\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "PUBLIC_KEY=$PUBLIC_KEY" >> $GITHUB_OUTPUT
          echo "### ðŸ“± App Deployed to Appetize!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Public Key:** \`$PUBLIC_KEY\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Direct Link:** https://appetize.io/app/$PUBLIC_KEY" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Embed URL:** \`https://appetize.io/embed/$PUBLIC_KEY?device=iphone15pro&osVersion=17.0\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: VirtualDeck-iOS
          path: VirtualDeck.zip
          retention-days: 7
