name: Build and Deploy to Appetize

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Install XcodeGen
        run: |
          # Install specific version compatible with Xcode 15
          brew install xcodegen

      - name: Generate Xcode Project
        run: |
          # Generate with explicit compatibility
          xcodegen generate --spec project.yml

          # Fix the project format if needed
          sed -i '' 's/objectVersion = 77/objectVersion = 56/g' VirtualDeck.xcodeproj/project.pbxproj || true

      - name: List available schemes
        continue-on-error: true
        run: xcodebuild -project VirtualDeck.xcodeproj -list

      - name: Build for iOS Simulator (ARM64)
        run: |
          # List available simulators
          xcrun simctl list devices available

          xcodebuild build \
            -project VirtualDeck.xcodeproj \
            -scheme VirtualDeck \
            -sdk iphonesimulator \
            -destination 'generic/platform=iOS Simulator' \
            -configuration Debug \
            -derivedDataPath ./build \
            ARCHS=arm64 \
            VALID_ARCHS=arm64 \
            CODE_SIGNING_ALLOWED=NO

      - name: Verify and zip the app
        run: |
          APP_PATH=$(find ./build -name "*.app" -type d | head -1)
          echo "Found app at: $APP_PATH"

          echo "### App Bundle Verification ###"
          echo ""
          echo "=== Full bundle listing ==="
          find "$APP_PATH" -type f | head -50
          echo ""

          echo "=== Info.plist Check ==="
          if [ -f "$APP_PATH/Info.plist" ]; then
            echo "âœ… Info.plist found"
            echo "Key values:"
            /usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$APP_PATH/Info.plist" 2>/dev/null || echo "No CFBundleIdentifier"
            /usr/libexec/PlistBuddy -c "Print :CFBundleExecutable" "$APP_PATH/Info.plist" 2>/dev/null || echo "No CFBundleExecutable"
            /usr/libexec/PlistBuddy -c "Print :MinimumOSVersion" "$APP_PATH/Info.plist" 2>/dev/null || echo "No MinimumOSVersion"
            echo ""
            echo "Full Info.plist:"
            cat "$APP_PATH/Info.plist"
          else
            echo "âŒ Missing Info.plist!"
            exit 1
          fi
          echo ""

          echo "=== Executable Check ==="
          APP_NAME=$(basename "$APP_PATH" .app)
          if [ -f "$APP_PATH/$APP_NAME" ]; then
            echo "âœ… Executable: $APP_NAME"
            file "$APP_PATH/$APP_NAME"
            lipo -info "$APP_PATH/$APP_NAME" || true
            ls -lh "$APP_PATH/$APP_NAME"
          else
            echo "âŒ Missing executable!"
            ls -la "$APP_PATH/"
            exit 1
          fi
          echo ""

          echo "=== Assets Check ==="
          ls -la "$APP_PATH/" | grep -E "Assets|car" || echo "No Assets.car"
          echo ""

          echo "=== Creating ZIP ==="
          cd $(dirname "$APP_PATH")
          zip -r VirtualDeck.zip $(basename "$APP_PATH")
          mv VirtualDeck.zip $GITHUB_WORKSPACE/
          ls -lh $GITHUB_WORKSPACE/VirtualDeck.zip
          echo ""
          echo "=== ZIP Contents ==="
          unzip -l $GITHUB_WORKSPACE/VirtualDeck.zip | head -30

      - name: Upload to Appetize.io
        id: appetize
        run: |
          echo "Uploading VirtualDeck.zip to Appetize.io..."
          echo "File size: $(ls -lh VirtualDeck.zip | awk '{print $5}')"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.appetize.io/v1/apps" \
            -H "X-API-KEY: ${{ secrets.APPETIZE_API_TOKEN }}" \
            -F "file=@VirtualDeck.zip" \
            -F "platform=ios")

          # Extract HTTP status code (last line) and response body
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status Code: $HTTP_CODE"
          echo "Appetize Response: $BODY"

          # Check for errors
          if [[ "$HTTP_CODE" != "200" ]]; then
            echo "### âŒ Appetize Upload Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**HTTP Status:** $HTTP_CODE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Response:** \`$BODY\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Check if publicKey is present
          PUBLIC_KEY=$(echo "$BODY" | jq -r '.publicKey // empty')
          if [[ -z "$PUBLIC_KEY" ]]; then
            echo "### âŒ Appetize Upload Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Error:** No publicKey in response" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Response:** \`$BODY\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "PUBLIC_KEY=$PUBLIC_KEY" >> $GITHUB_OUTPUT
          echo "### ðŸ“± App Deployed to Appetize!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Public Key:** \`$PUBLIC_KEY\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Direct Link:** https://appetize.io/app/$PUBLIC_KEY" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Embed URL:** \`https://appetize.io/embed/$PUBLIC_KEY?device=iphone15pro&osVersion=17.0\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: VirtualDeck-iOS
          path: VirtualDeck.zip
          retention-days: 7
