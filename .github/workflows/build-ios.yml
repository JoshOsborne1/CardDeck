name: Build and Deploy to Appetize

on:
  push:
    branches: [main, master]
  workflow_dispatch: # Allow manual trigger

jobs:
  build-ios:
    runs-on: macos-14 # Latest macOS with Xcode 15+

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Build for iOS Simulator
        run: |
          xcodebuild build \
            -project VirtualDeck.xcodeproj \
            -scheme VirtualDeck \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
            -configuration Debug \
            -derivedDataPath ./build \
            CODE_SIGNING_ALLOWED=NO

      - name: Find and zip the app
        run: |
          APP_PATH=$(find ./build -name "*.app" -type d | head -1)
          echo "Found app at: $APP_PATH"
          cd $(dirname "$APP_PATH")
          zip -r VirtualDeck.zip $(basename "$APP_PATH")
          mv VirtualDeck.zip $GITHUB_WORKSPACE/

      - name: Upload to Appetize.io
        id: appetize
        run: |
          RESPONSE=$(curl -s -X POST "https://api.appetize.io/v1/apps" \
            -H "Authorization: Bearer ${{ secrets.APPETIZE_API_TOKEN }}" \
            -F "file=@VirtualDeck.zip" \
            -F "platform=ios")

          echo "Appetize Response: $RESPONSE"

          PUBLIC_KEY=$(echo $RESPONSE | jq -r '.publicKey')
          echo "PUBLIC_KEY=$PUBLIC_KEY" >> $GITHUB_OUTPUT
          echo "### ðŸ“± App Deployed to Appetize!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Public Key:** \`$PUBLIC_KEY\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Direct Link:** https://appetize.io/app/$PUBLIC_KEY" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Embed URL:** \`https://appetize.io/embed/$PUBLIC_KEY?device=iphone15pro&osVersion=17.0\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: VirtualDeck-iOS
          path: VirtualDeck.zip
          retention-days: 7
